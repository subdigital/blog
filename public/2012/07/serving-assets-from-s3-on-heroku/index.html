
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Serving Assets from S3 on Heroku - Fickle Bits</title>
  <meta name="author" content="Ben Scheirman">

  
  <meta name="description" content="Recently I changed NSScreencast to use a CDN
to serve up assets from a different, faster server. Why use a CDN? Using a CDN has numerous benefits. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://benscheirman.com/2012/07/serving-assets-from-s3-on-heroku/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/ficklebits" rel="alternate" title="Fickle Bits" type="application/atom+xml">
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-210379-10']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Fickle Bits</a></h1>
  
    <h2>You're doing it wrong.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/ficklebits" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:benscheirman.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/about-me">About Me</a></li>
  <li><a href="/speaking">Speaking</a></li>
  <li><a href="/contact">Contact</a></li>
  <li><a href="/projects">Projects</a></li>
  <!-- <li><a href="http://giggletouch.com">Giggle Touch</a></li> -->
  <!-- <li><a href="http://appkickstand.com">AppKickstand</a></li> -->
  <li><a href="/blog/archives">Archives</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Serving Assets From S3 on Heroku</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-07T11:17:00-05:00" pubdate data-updated="true">Jul 7<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Recently I changed <a href="http://nsscreencast.com">NSScreencast</a> to use a <a href="http://en.wikipedia.org/wiki/Content_delivery_network">CDN</a>
to serve up assets from a different, faster server.</p>

<h2>Why use a CDN?</h2>

<p>Using a CDN has numerous benefits.  First, and foremost, this alleviates a bunch of secondary requests that
would normally hit your webserver.  Loading the home page of NSScreencast loads more than a dozen images, stylesheets, and
javascript files.  When deploying to Heroku this can be especially problematic as each asset request will occupy one of your
dynos for a short time.  In the spirit of maximizing your free dyno on Heroku, not sending these requests to your app is definitely
a big win.</p>

<p>In addition, most browsers have a setting that limits the number of connections (usually 2) that it will open
in parallel to a given domain.  By using a CDN, you can increase the number of parallel requests
because these assets are not served up by your application&#8217;s domain.</p>

<p>It&#8217;s also a common practice to use dns to &#8220;alter&#8221; the domain so that you can maximize this parallelization.</p>

<h2>Using the asset sync gem</h2>

<p>Following the instructions on <a href="https://devcenter.heroku.com/articles/cdn-asset-host-rails31">Heroku&#8217;s Devcenter article</a> I
decided to use the <code>asset_sync</code> gem.  This gem will upload your compiled assets to your preferred CDN (any file storage server that
<a href="https://github.com/fog/fog/">fog</a> supports).  In my case, I wanted to use S3.</p>

<p>The first step is adding this gem to your <code>Gemfile</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># other asset gems</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;asset_sync&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s important to put this in your asset group, as your running app doesn&#8217;t need to load this into memory.</p>

<p>Then you need to configure the gem.  I found Heroku&#8217;s instructions to be lacking here, as I had to dig into
the <a href="https://github.com/rumblelabs/asset_sync"><code>asset_sync</code> github page</a> to make this work.</p>

<p>Add a file called <code>config/initializers/asset_sync.rb</code> to your app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Since this gem is only loaded with the assets group, we have to check to </span>
</span><span class='line'><span class="c1"># see if it&#39;s defined before configuring it.</span>
</span><span class='line'><span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">AssetSync</span><span class="p">)</span>
</span><span class='line'>  <span class="no">AssetSync</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">fog_provider</span> <span class="o">=</span> <span class="s1">&#39;AWS&#39;</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">aws_access_key_id</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;AWS_ACCESS_KEY_ID&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">aws_secret_access_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;AWS_SECRET_ACCESS_KEY&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">fog_directory</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;FOG_DIRECTORY&#39;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Fail silently.  Useful for environments such as Heroku</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">fail_silently</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That last config line is important.  When you deploy to Heroku, your app&#8217;s assets will get precompiled.  But because Heroku
doesn&#8217;t initialize your app on precompile, none of your settings will be available.  Instead we&#8217;ll have to run the precompile again,
manually, to get AssetSync to kick in.</p>

<h2>Setting up the configuration with Heroku San</h2>

<p>Since I like to have multiple environments, I use <a href="https://github.com/fastestforward/heroku_san"><code>heroku_san</code></a> to manage them, including
the environment variables.</p>

<p>Inside of <code>config/heroku.yml</code>, set up the following for each environment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FOG_PROVIDER</span><span class="p">:</span> <span class="s2">&quot;AWS&quot;</span>
</span><span class='line'><span class="no">FOG_DIRECTORY</span><span class="p">:</span> <span class="s2">&quot;nsscreencast-assets&quot;</span>
</span><span class='line'><span class="no">AWS_ACCESS_KEY_ID</span><span class="p">:</span> <span class="s2">&quot;&lt;your access key&gt;&quot;</span>
</span><span class='line'><span class="no">AWS_SECRET_ACCESS_KEY</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Configuring Your Rails app to use S3 as an Asset Host</h2>

<p>In your <code>config/production.rb</code> (and <code>staging.rb</code> if you have one), make sure to add the
following line to allow Rails to generate the appropriate links for your assets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">asset_host</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">source</span><span class="p">,</span> <span class="n">request</span><span class="o">|</span>
</span><span class='line'>    <span class="n">scheme</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">ssl?</span> <span class="p">?</span> <span class="s2">&quot;https&quot;</span> <span class="p">:</span> <span class="s2">&quot;http&quot;</span>
</span><span class='line'>    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">scheme</span><span class="si">}</span><span class="s2">://</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;FOG_DIRECTORY&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">.s3.amazonaws.com&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will allow your app to serve up the URLs using SSL if the request is coming via SSL.  Doing
this can avoid warnings in the browser that your app contains secure and unsecure content.</p>

<h2>Testing it all out</h2>

<p>If all of this is configured correctly, you can test it out by doing a push&#8230;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">git</span> <span class="n">push</span> <span class="n">heroku</span> <span class="n">master</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&#8217;ll see the asset precompile going on in the logs, and likely an error related to AssetSync.  This is fine (and
in fact, this tripped me up at first).  Once
the deploy has completed, you&#8217;ll have to run this command to upload your assets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">heroku</span> <span class="n">run</span> <span class="n">rake</span> <span class="n">assets</span><span class="ss">:precompile</span> <span class="o">--</span><span class="n">app</span> <span class="o">&lt;</span><span class="n">yourapp</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doing this, you should see something like the following output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Precompiling</span> <span class="n">assets</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="no">Uploading</span><span class="p">:</span> <span class="n">application</span><span class="o">.</span><span class="n">css</span>
</span><span class='line'><span class="no">Uploading</span><span class="p">:</span> <span class="n">application</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">gz</span>
</span><span class='line'><span class="no">Uploading</span><span class="p">:</span> <span class="n">image1</span><span class="o">.</span><span class="n">png</span>
</span><span class='line'><span class="no">Uploading</span><span class="p">:</span> <span class="n">image2</span><span class="o">.</span><span class="n">png</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Set up Heroku San to do this on every deploy</h2>

<p>I&#8217;d likely forget to run this command every once in a while, so I set up Heroku San to run this command
after every deploy.</p>

<p>To do this, add a new rake task in your app (<code>lib/tasks/deploy.rake</code>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:after_deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">HerokuSan</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">each_app</span> <span class="k">do</span> <span class="o">|</span><span class="n">stage</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;---&gt; Precompiling asssets &amp; uploading to the CDN&quot;</span>
</span><span class='line'>    <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;heroku run rake assets:precompile --app </span><span class="si">#{</span><span class="n">stage</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now when you run your deploy via <code>rake production deploy</code> this will happen automatically.</p>

<h2>So what&#8217;s the net result?</h2>

<p>Doing this alleviated nearly 30 secondary requests to my application for each page load.  That alone is pretty huge.  Also, S3 is
much faster at serving these assets than nginx is (at least via a Heroku app on 1 dyno).</p>

<p>I tested this before and after by clearing the cache and doing a fresh page load.  Using the Chrome Inspector, I looked at the time to load the page and all assets.
Here are my findings:</p>

<table style="margin: 25px;">
  <tr>
    <td style="border: solid 1px #ddd; padding: 3px 7px;">
      <strong>Before</strong> (<em>serving assets with no CDN</em>)
    </td>
    <td style="border: solid 1px #ddd; padding: 3px 7px;">3.27 seconds</td>
  </tr>
  <tr>
    <td style="border: solid 1px #ddd; padding: 3px 7px;"><strong>After</strong>
    (<em>using S3 as a CDN</em>)
    </td>
    <td style="border: solid 1px #ddd; padding: 3px 7px;">1.07 seconds</td>
  </tr>
</table>


<p>That&#8217;s a huge gain for a minor change in your application &amp; deployment process.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ben Scheirman</span></span>

      








  


<time datetime="2012-07-07T11:17:00-05:00" pubdate data-updated="true">Jul 7<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/rails/'>rails</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://benscheirman.com/2012/07/serving-assets-from-s3-on-heroku/" data-via="subdigital" data-counturl="http://benscheirman.com/2012/07/serving-assets-from-s3-on-heroku/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2012/02/hello/" title="Previous Post: Hello, NSScreencast">&laquo; Hello, NSScreencast</a>
      
      
        <a class="basic-alignment right" href="/2012/07/houston-code-camp-call-for-speakers/" title="Next Post: Houston Code Camp - Call for Speakers">Houston Code Camp - Call for Speakers &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Who am I?</h1>
  <p>I'm Ben Scheirman. I make Rails &amp; iPhone apps for <a href="http://chaione.com" target="_blank">ChaiONE</a> in Houston, TX.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/07/houston-code-camp-call-for-speakers/">Houston Code Camp - Call for Speakers</a>
      </li>
    
      <li class="post">
        <a href="/2012/07/serving-assets-from-s3-on-heroku/">Serving Assets from S3 on Heroku</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/hello/">Hello, NSScreencast</a>
      </li>
    
      <li class="post">
        <a href="/2012/01/nsscreencasts/">NSScreencasts, Coming Soon</a>
      </li>
    
      <li class="post">
        <a href="/2012/01/careful-with-block-based-notification-handlers/">Careful With Block-Based Notification Handlers</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("subdigital", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/subdigital" class="twitter-follow-button" data-show-count="false">Follow @subdigital</a>
  
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/subdigital?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/subdigital">My Delicious Bookmarks &raquo;</a></p>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo">
<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4f26d557844d525165000005');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>


<p>
  Copyright &copy; 2012 - Ben Scheirman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'subdigital';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://benscheirman.com/2012/07/serving-assets-from-s3-on-heroku/';
        var disqus_url = 'http://benscheirman.com/2012/07/serving-assets-from-s3-on-heroku/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
