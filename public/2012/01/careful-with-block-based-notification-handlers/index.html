
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
      Careful With Block-Based Notification Handlers - 
    
    Fickle Bits
  </title>
  <meta name="author" content="Ben Scheirman">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://benscheirman.com/2012/01/careful-with-block-based-notification-handlers/"/>
  <link href="/favicon.png" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/ficklebits" rel="alternate" title="Fickle Bits" type="application/atom+xml"/>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-210379-10']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/">Fickle Bits</a></h1>
  
    <h2>You're doing it wrong.</h2>
  
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/ficklebits" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:benscheirman.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/about-me">About Me</a></li>
  <li><a href="/speaking">Speaking</a></li>
  <li><a href="/contact">Contact</a></li>
  <li><a href="http://giggletouch.com">Giggle Touch for
    iOS</a></li>
  <li><a href="http://appkickstand.com">AppKickstand</a></li>
  <li><a href="/blog/archives">Archives</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">Careful With Block-Based Notification Handlers</h1>
    
    
      <p class="meta">




<time datetime="2012-01-11 16:27:00 -0600" pubdate  updated >Jan 11<span>th</span>, 2012</time>


</p>
    
  </header>


<div class="entry-content"><p>In general, I prefer using block-based APIs over those that accept selectors.</p>

<p>The block based APIs are generally easier to read &amp; follow, and don&#8217;t clutter up your class with methods that are
out of context with the code that might potentially invoke them.</p>

<h2>An Example</h2>

<p>One good example is view animations.  Here we&#8217;re fading out a view and removing it from the hierarchy once
the view has been completely faded out.  It&#8217;s concise, easy to read, and you don&#8217;t need to go anywhere else in the
class to get a complete picture of how this works.</p>

<p>Also, since you can have multiple animations going on, having a block-based completion handler means
you don&#8217;t have to distinguish between what the animations were in some generic completion method.</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
</pre></td><td class='code' width='100%'><pre><code class='objc'><div class='line'><span class="p">[</span><span class="n">UIView</span> <span class="nl">animateWithDuration:</span><span class="mf">0.5</span> <span class="nl">animations:</span><span class="o">^</span><span class="p">{</span>
</div><div class='line'>  <span class="n">someView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</div><div class='line'><span class="p">}</span> <span class="nl">completion:</span><span class="o">^</span> <span class="p">(</span><span class="kt">BOOL</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
</div><div class='line'>  <span class="p">[</span><span class="n">someView</span> <span class="n">removeFromSuperView</span><span class="p">];</span>
</div><div class='line'><span class="p">}];</span>
</div></code></pre></td></tr></table></div></figure>

<p>Contrast this with the non-block version:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
</pre></td><td class='code' width='100%'><pre><code class='objc'><div class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">fadeOutView</span> <span class="p">{</span>
</div><div class='line'>  <span class="p">[</span><span class="n">UIView</span> <span class="n">beginAnimations</span><span class="p">];</span>
</div><div class='line'>  <span class="p">[</span><span class="n">UIView</span> <span class="nl">setAnimationDuration:</span><span class="mf">0.5</span><span class="p">];</span>
</div><div class='line'>  <span class="p">[</span><span class="n">UIView</span> <span class="nl">setAnimationDelegate:</span><span class="n">self</span><span class="p">];</span>
</div><div class='line'>  <span class="p">[</span><span class="n">UIView</span> <span class="nl">setAnimationDidStopSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">animationDidStop:finished:context:</span><span class="p">)];</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">someView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</div><div class='line'>
</div><div class='line'>  <span class="p">[</span><span class="n">UIView</span> <span class="n">commitAnimations</span><span class="p">];</span>
</div><div class='line'><span class="p">}</span>
</div><div class='line'>
</div><div class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">animationDidStop:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">animationID</span> <span class="nl">finished:</span><span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span><span class="n">finished</span> <span class="nl">context:</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">context</span> <span class="p">{</span>
</div><div class='line'>  <span class="p">[</span><span class="n">someView</span> <span class="n">removeFromSuperView</span><span class="p">];</span>
</div><div class='line'><span class="p">}</span>
</div></code></pre></td></tr></table></div></figure>

<h2>Block-Based Notification Handlers</h2>

<p><code>NSNotificationCenter</code> also got some block love when iOS SDK 4.0 came around.  The old form looked like this:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
</pre></td><td class='code' width='100%'><pre><code class='objc'><div class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setupNotifications</span> <span class="p">{</span>
</div><div class='line'>  <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">addObserver:</span><span class="n">self</span>
</div><div class='line'>                                           <span class="nl">selector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">onWhizBang:</span><span class="p">)</span>
</div><div class='line'>                                               <span class="nl">name:</span><span class="n">MyWhizBangnotification</span>
</div><div class='line'>                                             <span class="nl">object:</span><span class="nb">nil</span><span class="p">];</span>
</div><div class='line'><span class="p">}</span>
</div><div class='line'>
</div><div class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">onWhizBang:</span><span class="p">(</span><span class="n">NSNotification</span> <span class="o">*</span><span class="p">)</span><span class="n">notification</span> <span class="p">{</span>
</div><div class='line'>  <span class="c1">// reload the table to show the new whiz bangs</span>
</div><div class='line'>  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
</div><div class='line'><span class="p">}</span>
</div><div class='line'>
</div><div class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">dealloc</span> <span class="p">{</span>
</div><div class='line'>  <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">removeObserver:</span><span class="n">self</span><span class="p">];</span>
</div><div class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">dealloc</span><span class="p">];</span>
</div><div class='line'><span class="p">}</span>
</div></code></pre></td></tr></table></div></figure>

<p>This isn&#8217;t a lot of code (and it is easy to remember, unlike the previous UIView animation block code), however
the action and the notification handler are separated from each other.</p>

<p>The block-based API looks like this:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
</pre></td><td class='code' width='100%'><pre><code class='objc'><div class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setupNotifications</span> <span class="p">{</span>
</div><div class='line'>  <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span>
</div><div class='line'>      <span class="nl">addObserverForNotificationName:</span><span class="n">MyWhizBangNotification</span>
</div><div class='line'>                              <span class="nl">object:</span><span class="nb">nil</span>
</div><div class='line'>                               <span class="nl">queue:</span><span class="p">[</span><span class="n">NSOperationQueue</span> <span class="n">mainQueue</span><span class="p">]</span>
</div><div class='line'>                               <span class="nl">block:</span><span class="o">^</span><span class="p">(</span><span class="n">NSNotification</span> <span class="o">*</span><span class="n">notification</span><span class="p">)</span> <span class="p">{</span>
</div><div class='line'>                                 <span class="c1">//reload the table to show the new whiz bangs</span>
</div><div class='line'>                                 <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
</div><div class='line'>                               <span class="p">}];</span>
</div><div class='line'><span class="p">}</span>
</div><div class='line'>
</div><div class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">dealloc</span> <span class="p">{</span>
</div><div class='line'>  <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">removeObserver:</span><span class="n">self</span><span class="p">];</span>
</div><div class='line'>  <span class="p">[</span><span class="n">super</span> <span class="n">dealloc</span><span class="p">];</span>
</div><div class='line'><span class="p">}</span>
</div></code></pre></td></tr></table></div></figure>

<p>Aside from some funky indentation, this is preferable in some cases, especially when the action to
be completed is as simple as reloading the table.</p>

<p>But there&#8217;s a bug.  Can you spot it?</p>

<h2>Blocks Are Closures</h2>

<p>There&#8217;s a subtle bug here that you might not notice at first.  I didn&#8217;t realize this until it was littered all
over my code base.</p>

<p>Blocks are <a href="http://simple.wikipedia.org/wiki/Closure_(computer_science)">closures</a>, and they will capture any values declared outside the scope of the block (and retained) so that
they can be used when the block executes.  This includes variables declared in the enclosing method or any ivars
that you reference from inside the block.</p>

<p>Here, we used <code>self.tableView</code>.  <code>self</code> gets retained by the block, which is also retained by self.  We have a <em>retain-cycle</em>
which is generally a bad thing.  It&#8217;s especially bad here, because we don&#8217;t clear out the block until <code>dealloc</code>,
but <em>dealloc won&#8217;t ever be called because the block is retaining the instance</em>!</p>

<h2>Weak Pointers Save the Day</h2>

<p>If you&#8217;ve read up on blocks, you&#8217;ve probably seen the <code>__block</code> keyword.  This specifier tells blocks not to retain the pointer.
So all we need is a new pointer, like so:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
</pre></td><td class='code' width='100%'><pre><code class='objc'><div class='line'><span class="n">__block</span> <span class="n">MyViewController</span> <span class="o">*</span><span class="n">weakSelf</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</div><div class='line'>
</div><div class='line'><span class="c1">// use weakSelf in the blocks, instead of self</span>
</div></code></pre></td></tr></table></div></figure>

<p>This sort of code drives me nuts.  It won&#8217;t be apparent to the next developer why it&#8217;s there, and it&#8217;s
pretty ugly.</p>

<h2>Retain Cycles are Elsewhere, Too</h2>

<p>You might also run into this if you have a parent-child view controller relationship, or perhaps a
an parent->object->delegate chain, where the parent <em>is</em> the delegate.  This is why you typically mark
your delegate property signatures with <code>assign</code> instead of <code>retain</code> semantics.</p>

<p>Not all retain-cycles are terrible though.  If you have a way of breaking the cycle, then you just need
to weigh how long these objects will remain active for to decide if you need to fix it.</p>

<p>Hopefully this will save you a few headaches down the line.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ben Scheirman</span></span>

      




<time datetime="2012-01-11 16:27:00 -0600" pubdate  updated >Jan 11<span>th</span>, 2012</time>



      

<span class="categories">
  
    <a class='category' href='/blog/categories/iOS/'>iOS</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://benscheirman.com/2012/01/careful-with-block-based-notification-handlers/" data-via="subdigital" data-counturl="http://benscheirman.com/2012/01/careful-with-block-based-notification-handlers/" >Tweet</a>
  
  
  <g:plusone size="medium"></g:plusone>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'subdigital';
  var disqus_identifier = 'http://benscheirman.com/2012/01/careful-with-block-based-notification-handlers/';
  var disqus_url = 'http://benscheirman.com/2012/01/careful-with-block-based-notification-handlers/';
  //var disqus_developer = 1;
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside role=sidebar>
  
    <section>
  <h1>Who am I?</h1>
  <p>I&#8217;m Ben Scheirman. I make Rails &amp; iPhone apps for <a href="http://chaione.com" target="_blank">ChaiONE</a> in Houston, TX.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/01/nsscreencasts/">NSScreencasts, Coming Soon</a>
      </li>
    
      <li class="post">
        <a href="/2012/01/careful-with-block-based-notification-handlers/">Careful With Block-Based Notification Handlers</a>
      </li>
    
      <li class="post">
        <a href="/2011/12/formatting-json-from-terminal/">Formatting JSON From Terminal</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/houston-tech-fest-2011-recap/">Houston Tech Fest 2011 Recap</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/appsites-is-now-appkickstand/">Appsites Is Now AppKickstand</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("subdigital", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/subdigital" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @subdigital</a>
  
</section>


<section>
  <h1>On Delicious</h1>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/js/subdigital?title=&count=3&sort=date&extended"></script>
  <p><a href="http://delicious.com/subdigital">My Delicious Bookmarks &raquo;</a></p>
</section>



  
</aside>


    </div>
  </div>
  <footer>
<a style="display:block; float: right" title="Real Time Analytics" href="http://getclicky.com/66470389"><img alt="Real Time Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a>
<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(66470389); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66470389ns.gif" /></p></noscript>

<p>
  Copyright &copy; 2012 - Ben Scheirman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
</body>
</html>
