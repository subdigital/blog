
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Load Testing our Heroku app - Fickle Bits</title>
  <meta name="author" content="Ben Scheirman">

  
  <meta name="description" content="I&#8217;ve said many times before how much I love Heroku. Though they&#8217;ve had an unusually large amount of downtime this week (~1 hour), I&#8217 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://benscheirman.com/2010/08/load-testing-our-heroku-app/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/ficklebits" rel="alternate" title="Fickle Bits" type="application/atom+xml">
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-210379-10']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Fickle Bits</a></h1>
  
    <h2>You're doing it wrong.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/ficklebits" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:benscheirman.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/about-me">About Me</a></li>
  <li><a href="/speaking">Speaking</a></li>
  <li><a href="/contact">Contact</a></li>
  <li><a href="/projects">Projects</a></li>
  <!-- <li><a href="http://giggletouch.com">Giggle Touch</a></li> -->
  <!-- <li><a href="http://appkickstand.com">AppKickstand</a></li> -->
  <li><a href="/blog/archives">Archives</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Load Testing Our Heroku App</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-08-06T00:00:00-05:00" pubdate data-updated="true">Aug 6<span>th</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I&#8217;ve said many times before how much I love Heroku. Though they&#8217;ve had an unusually large amount of downtime this week (~1 hour), I&#8217;m still loving their service. One of the applications that we&#8217;re building is expecting a large wave of traffic shortly following a blitz PR campaign. The golden question of the hour is: How much traffic can we handle?</p>

<p>Currently we&#8217;re on the Koi 1 plan, which gives us a 20GB database (shared) and 1 dyno. A &#8220;dyno&#8221; is basically 1 concurrent request. It&#8217;s very similar to a super market. You get in line and you are served in the order in which you came. If some jackass has a cartload of Natural Light &amp; Cheeze Whiz in front of you, you&#8217;re gonna have to wait a while. Adding another Dyno is like opening a 2nd lane.</p>

<p>The key to good performance on Heroku is to watch the Queue Depth. If you ever reach too many people in the queue at one time your app will stop serving up requests past that mark, you&#8217;ll get a Backlog Too Deep error. I&#8217;m not sure what the limit is, but I&#8217;m guessing it&#8217;s around 100 (which is HUGE).</p>

<p>For more information on Heroku performance, see their <a href="http://docs.heroku.com/performance" target="_blank">excellent docs</a>.</p>

<p>To perform my tests I&#8217;m using 2 tools: <a href="http://httpd.apache.org/docs/2.0/programs/ab.html" target="_blank">Apache Bench</a> &amp; <a href="http://www.newrelic.com/" target="_blank">New Relic RPM</a>. Both are stellar.</p>

<h2>Test 1: Serving up the landing page (1 Dyno, 5000 requests, 20 at a time)</h2>


<p>This is a simple GET request that the Heroku routing mesh likely caches heavily. There&#8217;s no database queries on the homepage and no logic.</p>

<h1>Requests: 5000Concurrency: 20# of Requests/Sec: 85</h1>

<p>This is pretty darn good. 50% of the requests are served in under 300ms and the max request took less than 1 second. No requests failed.</p>

<h2>Test 2: A simple API read operation (1 Dyno, 5000 requests, 20 at a time)</h2>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Concurrency Level: 20
</span><span class='line'>Time taken for tests:   68.067 seconds
</span><span class='line'>Complete requests:      5000
</span><span class='line'>Failed requests:        0
</span><span class='line'>Write errors:           0
</span><span class='line'>Total transferred:      4276315 bytes
</span><span class='line'>HTML transferred:       2665000 bytes
</span><span class='line'>&lt;strong>Requests per second:    73.46 [#/sec] (mean)&lt;/strong>
</span><span class='line'>Time per request:       272.267 [ms] (mean)
</span><span class='line'>Time per request:       13.613 [ms] (mean, across all concurrent requests)
</span><span class='line'>Transfer rate:          61.35 [Kbytes/sec] received
</span><span class='line'>Connection Times (ms)min  mean[+/-sd] median
</span><span class='line'>maxConnect:       68   75   4.2     74      97
</span><span class='line'>Processing:    85  197  73.9    180     607
</span><span class='line'>Waiting:       85  197  73.9    180     607
</span><span class='line'>Total:        157  272  73.8    255     685
</span><span class='line'>Percentage of the requests served within a certain time (ms)
</span><span class='line'>50%    255
</span><span class='line'>66%    291
</span><span class='line'>75%    313
</span><span class='line'>80%    325
</span><span class='line'>90%    365
</span><span class='line'>95%    407
</span><span class='line'>98%    477
</span><span class='line'>99%    535
</span><span class='line'>100%    685 (longest request)</span></code></pre></td></tr></table></div></figure>


<p>Again, great results. This is due to caching of course, but at least we know we can handle lots of requests on this API.</p>

<h2>Test 3: A simple API write operation (1 Dyno, 5000 requests, 20 at a time)</h2>


<p>This API operation inserts 2 records in the database. Again, 5000 requests, 20 at a time.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Concurrency Level:      20
</span><span class='line'>Time taken for tests:   320.981 seconds
</span><span class='line'>Complete requests:      5000
</span><span class='line'>&lt;strong>Failed requests:        4165
</span><span class='line'>&lt;/strong>   (Connect: 0, Receive: 0, Length: 4165, Exceptions: 0)
</span><span class='line'>Write errors:           0
</span><span class='line'>Total transferred:      4022365 bytes
</span><span class='line'>Total POSTed:           1935387
</span><span class='line'>HTML transferred:       2651618 bytes
</span><span class='line'>Requests per second:    15.58 [#/sec] (mean)
</span><span class='line'>Time per request:       1283.923 [ms] (mean)
</span><span class='line'>Time per request:       64.196 [ms] (mean, across all concurrent requests)
</span><span class='line'>Transfer rate:          12.24 [Kbytes/sec] received 5.89 kb/s sent  18.13 kb/s totalConnection 
</span><span class='line'>
</span><span class='line'>Times     (ms)min  mean[+/-sd] median
</span><span class='line'>maxConnect:   68   71   3.9     70     104
</span><span class='line'>Processing:   134 1210 865.8    975    5559
</span><span class='line'>Waiting:      134 1210 865.8    975    5558
</span><span class='line'>Total:        202 1281 865.7   1048    5627
</span><span class='line'>
</span><span class='line'>Percentage of the requests served within a certain time (ms)
</span><span class='line'>50%   1048
</span><span class='line'>66%   1364
</span><span class='line'>75%   1638
</span><span class='line'>80%   1819
</span><span class='line'>90%   2430
</span><span class='line'>95%   3176
</span><span class='line'>98%   3898
</span><span class='line'>99%   4248
</span><span class='line'>100%   5627 (longest request)</span></code></pre></td></tr></table></div></figure>


<p>You can see here that we failed 4165 requests. That&#8217;s not good! Let&#8217;s try adding a dyno and do it again.</p>

<h2>Test 4: A simple API write operation (2 Dynos, 5000 requests, 20 at a time)</h2>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Concurrency Level: 20
</span><span class='line'>Time taken for tests:   135.882 seconds
</span><span class='line'>Complete requests:      5000
</span><span class='line'>Failed requests:        0
</span><span class='line'>Write errors:           0
</span><span class='line'>Total transferred:      4045448 bytes
</span><span class='line'>Total POSTed:           1935774
</span><span class='line'>HTML transferred:       2675000 bytes
</span><span class='line'>Requests per second:    36.80 [#/sec] (mean)
</span><span class='line'>Time per request:       543.530 [ms] (mean)
</span><span class='line'>Time per request:       27.176 [ms] (mean, across all concurrent requests)
</span><span class='line'>Transfer rate:          29.07 [Kbytes/sec] received
</span><span class='line'>13.91 kb/s sent
</span><span class='line'>42.99 kb/s totalConnection Times (ms)min  mean[+/-sd] median
</span><span class='line'>maxConnect:       67   95  32.7     72     979
</span><span class='line'>Processing:   121  448 162.4    420    1481
</span><span class='line'>Waiting:      121  448 162.5    419    1481
</span><span class='line'>Total:        199  543 154.4    515    1549
</span><span class='line'>Percentage of the requests served within a certain time (ms)
</span><span class='line'>50%    515
</span><span class='line'>66%    580
</span><span class='line'>75%    624
</span><span class='line'>80%    654
</span><span class='line'>90%    751
</span><span class='line'>95%    840
</span><span class='line'>98%    946
</span><span class='line'>99%   1034
</span><span class='line'>100%   1549 (longest request)</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;re getting a pretty healthy 36 requests per second now, and look, no errors!</p>

<h2>Test 5: A simple API write operation (2 Dynos, 10000 requests, 20 at a time)</h2>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Concurrency Level: 20
</span><span class='line'>Time taken for tests:   326.317 seconds
</span><span class='line'>Complete requests:      10000
</span><span class='line'>Failed requests:        0
</span><span class='line'>Write errors:           0
</span><span class='line'>Total transferred:      8091062 bytes
</span><span class='line'>Total POSTed:           3870000
</span><span class='line'>HTML transferred:       5350000 bytes
</span><span class='line'>Requests per second:    30.65 [#/sec] (mean)
</span><span class='line'>Time per request:       652.634 [ms] (mean)
</span><span class='line'>Time per request:       32.632 [ms] (mean, across all concurrent requests)
</span><span class='line'>Transfer rate:          24.21 [Kbytes/sec] received
</span><span class='line'>11.58 kb/s sent
</span><span class='line'>35.80 kb/s totalConnection Times (ms)min  mean[+/-sd] median
</span><span class='line'>maxConnect:       68   72  13.8     70    1004
</span><span class='line'>Processing:   113  580 233.1    539    2145
</span><span class='line'>Waiting:      113  580 233.1    539    2145
</span><span class='line'>Total:        183  652 233.5    610    2213
</span><span class='line'>Percentage of the requests served within a certain time (ms)
</span><span class='line'>50%    610
</span><span class='line'>66%    701
</span><span class='line'>75%    771
</span><span class='line'>80%    822
</span><span class='line'>90%    971
</span><span class='line'>95%   1103
</span><span class='line'>98%   1254
</span><span class='line'>99%   1374
</span><span class='line'>100%   2213 (longest request)</span></code></pre></td></tr></table></div></figure>


<p>We slipped a tad on overall throughput (down to 30 reqs/sec) but we still served up all of the requests in a reasonable time without any failures.
Let&#8217;s check out New Relic &amp; See what it says.
<img src="/images/newrelic-heroku-testing2.png"  height="282"  /> In this graph you can see the overall HTTP Throughput (higher is better) against the Heroku backlog depth. The more dynos you have, the quicker your backlog is cleared out, equating to more throughput. You can clearly see that we are now hitting a limit on the throughput we can handle because the queue depth is increasing. We might choose to optimize the site or add another dyno to squeeze some more perf out of this.
Also in the image if you were to mouseover on the queue stacks on the website, you&#8217;d see that my peak queue depth was 29. That&#8217;s pretty high, and you can definitely see a cap in the total # of requests that we can serve.
In the end, I&#8217;m able to pretty reliably say that we can handle a 10k request spike when running on 2 dynos. I&#8217;d suggest more dynos if the client wanted to handle more than that.
Gotta love tools that make investigation like this easy. Props to Heroku &amp; New Relic.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ben Scheirman</span></span>

      








  


<time datetime="2010-08-06T00:00:00-05:00" pubdate data-updated="true">Aug 6<span>th</span>, 2010</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://benscheirman.com/2010/08/load-testing-our-heroku-app/" data-via="subdigital" data-counturl="http://benscheirman.com/2010/08/load-testing-our-heroku-app/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2010/07/using-carrierwave-with-mongoid/" title="Previous Post: Using CarrierWave with Mongoid">&laquo; Using CarrierWave with Mongoid</a>
      
      
        <a class="basic-alignment right" href="/2010/08/lone-star-ruby-conference/" title="Next Post: Lone Star Ruby Conference">Lone Star Ruby Conference &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Who am I?</h1>
  <p>I'm Ben Scheirman. I make Rails &amp; iPhone apps for <a href="http://chaione.com" target="_blank">ChaiONE</a> in Houston, TX.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/07/houston-code-camp-call-for-speakers/">Houston Code Camp - Call for Speakers</a>
      </li>
    
      <li class="post">
        <a href="/2012/07/serving-assets-from-s3-on-heroku/">Serving Assets from S3 on Heroku</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/hello/">Hello, NSScreencast</a>
      </li>
    
      <li class="post">
        <a href="/2012/01/nsscreencasts/">NSScreencasts, Coming Soon</a>
      </li>
    
      <li class="post">
        <a href="/2012/01/careful-with-block-based-notification-handlers/">Careful With Block-Based Notification Handlers</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("subdigital", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/subdigital" class="twitter-follow-button" data-show-count="false">Follow @subdigital</a>
  
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/subdigital?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/subdigital">My Delicious Bookmarks &raquo;</a></p>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo">
<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4f26d557844d525165000005');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>


<p>
  Copyright &copy; 2012 - Ben Scheirman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'subdigital';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://benscheirman.com/2010/08/load-testing-our-heroku-app/';
        var disqus_url = 'http://benscheirman.com/2010/08/load-testing-our-heroku-app/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
