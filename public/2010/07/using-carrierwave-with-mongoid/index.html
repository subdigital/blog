
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fickle Bits: Using CarrierWave with Mongoid</title>
  <meta name="author" content="Ben Scheirman">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://benscheirman.com/2010/07/using-carrierwave-with-mongoid/"/>
  <link href="/favicon.png" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/ficklebits" rel="alternate" title="Fickle Bits" type="application/atom+xml"/>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-210379-10']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/">Fickle Bits</a></h1>
  
    <h2>You're doing it wrong.</h2>
  
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/ficklebits" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:benscheirman.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/about-me">About Me</a></li>
  <li><a href="/speaking">Speaking</a></li>
  <li><a href="/contact">Contact</a></li>
  <li><a href="http://appsites.heroku.com/giggletouch">Giggle Touch for
    iOS</a></li>
  <li><a href="/blog/archives">Archives</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">Using CarrierWave With Mongoid</h1>
    
    
      <p class="meta">




<time datetime="2010-07-18 00:00:00 -0500" pubdate  updated >Jul 18<span>th</span>, 2010</time>


</p>
    
  </header>


<div class="entry-content"><p>I&#8217;m moving a side project over to Rails 3, and I purposely chose a set of technologies that I hadn&#8217;t used yet.</p>

<ul>
<li><a target="_blank" href="http://github.com/rails/rails">Rails 3</a></li>
<li><a target="_blank" href="http://mongoid.org/">Mongoid</a> (hosted on MongoHQ)</li>
<li><a target="_blank" href="http://haml-lang.com/">Haml</a></li>
<li><a target="_blank" href="http://github.com/jnicklas/carrierwave">CarrierWave</a> (for file uploads)</li>
</ul>


<p>I&#8217;ll post about the general experience of this project later, but suffice it to say I&#8217;m liking this stack a lot. But this post is specifically about using CarrierWave to handle file uploads.</p>

<p>CarrierWave is similar to Paperclip, however it already supported Rails 3 &amp; Mongoid, so I decided to check it out. It creates the notion of <em>uploaders</em> and places them in a folder next to your models, controllers, views. Each uploader class defines the settings post-processing options for these uploads. I like keeping these separate from the model (instead of how Paperclip does it).</p>

<p>Here is a sample PicUploader that I&#8217;m using:</p>

<div><figure role=code> <div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">class</span> <span class="nc">PicUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
</div><div class='line'>  <span class="kp">include</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">RMagick</span>
</div><div class='line'>  <span class="n">storage</span> <span class="ss">:s3</span>
</div><div class='line'>
</div><div class='line'>  <span class="c1"># Use Heroku&#39;s temp folder for uploads</span>
</div><div class='line'>  <span class="k">def</span> <span class="nf">cache_dir</span>
</div><div class='line'>    <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/tmp/uploads&quot;</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">process</span> <span class="ss">:resize_to_fit</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="o">]</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">version</span> <span class="ss">:tiny_thumb</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">process</span> <span class="ss">:resize_to_fill</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="o">]</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">version</span> <span class="ss">:thumb</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">process</span> <span class="ss">:resize_to_fill</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="o">]</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">extension_white_list</span>
</div><div class='line'>    <span class="sx">%w(jpg jpeg gif png)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure></div>


<p>I&#8217;m storing these images in S3, but in order to process the file upload &amp; do post-processing on an image,
it has to first be uploaded to a temp folder. I had to change this <code>cache_dir</code> to reflect heroku&#8217;s temp folder.</p>

<p>Note also that it has support for RMagick (or MiniMagick) in order to do post-processing on the file to resize
it to your needs. Here I&#8217;m resizing the file to best-fit a 600x600 square (maintaining aspect ratio). I also
have 2 thumbnail sizes that clip the image in order to fill an exact square. All of this happens for me when I
upload an image.</p>

<p>In order to utilize these files in your model, you have to import the necessary ORM adapter file so that when
you save your model the filename gets saved with it. Here is an example model using the mongoid adapter.</p>

<div><figure role=code> <div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;app/uploaders/pic&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;carrierwave/orm/mongoid&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="k">class</span> <span class="nc">Category</span>
</div><div class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</div><div class='line'>  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</div><div class='line'>  <span class="n">field</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</div><div class='line'>  <span class="n">mount_uploader</span> <span class="ss">:photo</span><span class="p">,</span> <span class="no">PicUploader</span>
</div><div class='line'>  <span class="n">references_many</span> <span class="ss">:items</span>
</div><div class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:description</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure></div>


<p>When a category is saved, the uploader processes all of the sizes we need &amp; stores them all in S3. The category can then access these image URLS simply by doing this:</p>

<ul>
<li><code>category.photo.url</code> (Full size)</li>
<li><code>category.photo.thumb.url</code> (200x200)</li>
<li><code>category.photo.tiny_thumb.url</code> (50x50)</li>
</ul>


<p>If you need to handle images in your site, you can&#8217;t really beat the simplicity of this.</p>

<p>It hasn&#8217;t all been sunshine &amp; roses, however. I have another model that accepts multiple images, so I made a
<code>Photo</code> model in order to capture the file &amp; an associated caption. My Item model <code>embeds_many :photos</code>.
It also is set up to <code>accept_nested_attributes_for :photos</code>, so that I can post multiple photos along with
an item form.</p>

<p>Unfortunately, the mongoid adapter which gives you the <code>mount_uploader</code> behavior, only works when you call
<code>save</code> directly on that object. Since my photos were being saved by it&#8217;s parent document, the upload never
happened. It <a target="_blank" href="http://github.com/jnicklas/carrierwave/issues#issue/81">looks like this is a bug with CarrierWave</a>, and I&#8217;m looking at potential ways of contributing a fix. Right now, I&#8217;m manually pulling out the photos &amp; saving them one-by-one after an item is saved, but that isn&#8217;t a great solution.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ben Scheirman</span></span>

      




<time datetime="2010-07-18 00:00:00 -0500" pubdate  updated >Jul 18<span>th</span>, 2010</time>



      

<span class="categories">
  
    <a class='category' href='/blog/categories/ruby/'>ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://benscheirman.com/2010/07/using-carrierwave-with-mongoid/" data-via="subdigital" data-counturl="http://benscheirman.com/2010/07/using-carrierwave-with-mongoid/" >Tweet</a>
  
  
  <g:plusone size="medium"></g:plusone>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'subdigital';
  var disqus_identifier = 'http://benscheirman.com/2010/07/using-carrierwave-with-mongoid/';
  var disqus_url = 'http://benscheirman.com/2010/07/using-carrierwave-with-mongoid/';
  //var disqus_developer = 1;
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside role=sidebar>
  
    <section>
  <h1>Who am I?</h1>
  <p>I&#8217;m Ben Scheirman. I make Rails &amp; iPhone apps for <a href="http://chaione.com" target="_blank">ChaiONE</a> in Houston, TX.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/10/making-a-uibutton-flip-over/">Making a UIButton Flip Over</a>
      </li>
    
      <li class="post">
        <a href="/2011/09/creating-a-glow-effect-for-uilabel-and-uibutton/">Creating a Glow Effect for UILabel and UIButton</a>
      </li>
    
      <li class="post">
        <a href="/2011/09/introducing-appsites/">Introducing App Sites</a>
      </li>
    
      <li class="post">
        <a href="/2011/09/firebug-style-debugging-for-ios/">Firebug-Style Visual Debugging for iOS</a>
      </li>
    
      <li class="post">
        <a href="/2011/08/vim---could-not-invoke-jslint/">Vim - Could Not Invoke JSLint</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("subdigital", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/subdigital" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @subdigital</a>
  
</section>


<section>
  <h1>On Delicious</h1>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/js/subdigital?title=&count=3&sort=date&extended"></script>
  <p><a href="http://delicious.com/subdigital">My Delicious Bookmarks &raquo;</a></p>
</section>



  
</aside>


    </div>
  </div>
  <footer>
<a style="display:block; float: right" title="Real Time Analytics" href="http://getclicky.com/66470389"><img alt="Real Time Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a>
<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(66470389); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66470389ns.gif" /></p></noscript>

<p>
  Copyright &copy; 2011 - Ben Scheirman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
</body>
</html>
